{% extends "monitor/base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<h1 class="mb-4">Admin Dashboard</h1>

<div class="mb-4">
  <h4>Total Access Logs: {{ total_logs }}</h4>
  <a class="btn btn-sm btn-secondary ms-2" href="{% url 'access_log' %}">View All Access Logs</a>
</div>

<!-- Top Row -->
<div class="row mb-5">
  <div class="col-md-4">
    <h4>Live Activity Feed</h4>
    <ul id="live-feed" class="list-group" style="max-height: 375px; overflow-y: auto;"></ul>
  </div>
  <div class="col-md-4">
    <h4>Top Users</h4>
    <canvas id="topUsersChart" height="200"></canvas>
  </div>
<div class="col-md-4">
  <h4>User Risk Scores</h4>
  <div style="max-height: 300px; overflow-y: auto;">
    <table class="table table-striped table-sm">
      <thead class="table-light">
        <tr>
          <th>User</th>
          <th>Risk Score</th>
          <th>Level</th>
        </tr>
      </thead>
      <tbody>
        {% for user in user_profiles %}
        <tr>
          <td>{{ user.username }}</td>
          <td>{{ user.risk_score }}</td>
          <td>
            {% if user.risk_score > 80 %}
              <span class="badge bg-danger">Critical</span>
            {% elif user.risk_score > 50 %}
              <span class="badge bg-warning">Medium</span>
            {% else %}
              <span class="badge bg-success">Low</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<hr class="border border-dark border-2 opacity-75 mb-5" />

<!-- Second Row -->
<div class="row mb-5">
  <div class="col-md-8">
    <h4>Anomalies</h4>
    <table class="table table-bordered table-sm">
      <thead class="table-danger">
        <tr>
          <th>User</th>
          <th>File</th>
          <th>Anomaly</th>
          <th>Detail</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% for anomaly in recent_anomalies %}
        <tr>
          <td>{{ anomaly.access_log.user.username }}</td>
          <td>{{ anomaly.access_log.file.name }}</td>
          <td>{{ anomaly.anomaly_type }}</td>
          <td>{{ anomaly.detail|truncatewords:12 }}</td>
          <td>{{ anomaly.access_log.timestamp }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>



<!-- Chart + Live Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function fetchLiveFeed() {
  const res = await fetch("/admin-dashboard/live-feed/");
  const data = await res.json();
  const list = document.getElementById("live-feed");
  list.innerHTML = "";
  data.forEach(entry => {
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.innerHTML = `<strong>${entry.user}</strong> accessed <em>${entry.file}</em> [${entry.sensitivity}] at ${entry.timestamp}`;
    list.appendChild(li);
  });
}
setInterval(fetchLiveFeed, 5000);
fetchLiveFeed();

async function loadCharts() {
  const res = await fetch("/admin-dashboard/data/");
  const { top_users, anomaly_types, sensitivity_counts } = await res.json();

  new Chart(document.getElementById("topUsersChart"), {
    type: "bar",
    data: {
      labels: top_users.map(x => x.user__username),
      datasets: [{
        label: "Top Users by Accesses",
        data: top_users.map(x => x.count),
        backgroundColor: "#0d6efd",
      }]
    }
  });
}
loadCharts();
</script>
{% endblock %}
